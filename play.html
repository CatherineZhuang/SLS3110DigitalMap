<html>
<head>
    <meta charset=utf-8 />
    <title>Grove Park Asset Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
    <link rel='stylesheet' type='text/css' href='styles.css'>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>

    <style type="text/css">

        body {
            margin: 0;
        }

        #demo-container {
            text-align: center;
            margin: 40px auto;
        }

        #file-input-label {
            width: 200px;
            cursor: pointer;
            background-color: #336699;
            color: white;
            padding: 10px;
            display: block;
            margin: 0 auto;
        }

        #file-input {
            display: none;
        }

        #file-progress-container {
            display: none;
            margin: 15px 0 0 0;
        }

        #contents {
            margin: 15px 0 0 0;
            display: none;
            text-align: left;
            background-color: rgba(0,0,0,0.1);
            padding: 10px;
            font-size: 13px;
            max-height: 300px;
            overflow: auto;
        }

        #info {
            display: block;
            position: relative;
            margin: 0px auto;
            width: 50%;
            padding: 10px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
            color: #222;
            background: #fff;
        }

    </style>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.5/firebase-firestore.js"></script>

    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCwplrNiLnJIOvslAUQXX7WNrEkKSWfUhE",
            authDomain: "mapcom-209c9.firebaseapp.com",
            databaseURL: "https://mapcom-209c9.firebaseio.com",
            projectId: "mapcom-209c9",
            storageBucket: "mapcom-209c9.appspot.com",
            messagingSenderId: "48147695104",
            appId: "1:48147695104:web:4e142081ceaf45dcdc7ae5",
            measurementId: "G-4R3DV299WF"
        };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>

</head>

<body onload="getUserData()">

    <div id='map'></div>
    <pre id='info'></pre>
    <div id='console'>
        <h1>Grove Park Area Recent Development Projects</h1>
        <p>Data:
            <a href='https://groveparkfoundation.org'>Community Development Project Data</a> Last Updated Jan 2019</p>
        <h2>Type of Assets</h2>
        <div id='legends'></div>
        <div class='session' id='sliderbar'>
            <h2>Year:
                <label id='active-hour'>2015-2025</label>
            </h2>
            <input id='slider' class='row' type='range' min='2015' max='2025' step='1' value='2019' />
            <label id='yr'></label>
        </div>
        <div id="demo-container">
            <label for="file-input" id="file-input-label">Upload CSV File</label>
            <input type="file" id="file-input" accept="text/csv" />
            <div id="file-progress-container"><span id="file-progress-percent"></span>% read</div>
            <div id="contents"></div>
        </div>
    </div>

    <script type="text/javascript">
        
        var userdata = {
            "type": "FeatureCollection",
            "features": []
        }

        // will hold CSV data
        var data = [];

        function getUserData() {
            db.collection("mapdata").orderBy("time", "desc").limit(1).get()
            .then((snapshot) => {
                console.log(snapshot)
                snapshot.docs.forEach(doc => {
                    userdata = (doc.data()['userdata']);
                });
            });
        }
        
        document.querySelector("#file-input").addEventListener('change', function() {
            // files that user has chosen
            var all_files = this.files;
            if(all_files.length == 0) {
                alert('Error : No file selected');
                return;
            }

            // first file selected by user
            var file = all_files[0];

            // files types allowed
            var allowed_types = [ 'text/csv' ];
            if(allowed_types.indexOf(file.type) == -1) {
                alert('Error : Incorrect file type');
                return;
            }

            // Max 2 MB allowed
            var max_size_allowed = 2*1024*1024
            if(file.size > max_size_allowed) {
                alert('Error : Exceeded size 2MB');
                return;
            }

            // file validation is successfull
            // we will now read the file

            var reader = new FileReader();

            // rough algorithm to get CSV data from text
            reader.addEventListener('load', function(e) {
                data = [];
                // contents as text
                var text = e.target.result;

                // split by line breaks
                var rows = text.split("\r");

                for(var i=0; i<rows.length; i++) {
                    // split each row by comma
                    var row_columns = rows[i].split(",");

                    data.push(row_columns);
                }

                // CSV data
                console.log(data);

                // Build the new JSON file
                buildJSON(data);

                // Store to firebase
                var datetime = String(new Date().getTime());
                db.collection("mapdata").doc(datetime).set({
                    userdata,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                }).then(function(docRef) {
                    console.log("stored new map data to firebase");
                });

                // Update the map data source
                map.getSource("assets").setData(userdata);
            });

            // file reading failed
            reader.addEventListener('error', function() {
                alert('Error : Failed to read file');
            });

            // read as text file
            reader.readAsText(file);
        });

        function buildJSON(data) {
            for (var i=1; i < data.length; i++) {
                console.log("here");
                var item = {};
                item["type"] = "Feature";
                var propVal = {};
                propVal["Year"] = parseInt(data[i][0]);
                propVal["Name"] = data[i][1];
                propVal["Type"] = data[i][2];
                propVal["Number"] = 1;
                propVal["description"] = data[i][3];
                item["properties"] = propVal;
                var geoVal = {};
                geoVal["type"] = "Point";
                geoVal["coordinates"] = [parseFloat(data[i][5]), parseFloat(data[i][4])];
                item["geometry"] = geoVal;
                userdata["features"] = []
                userdata["features"].push(item);
            }
        }

        // place with Mapbox token before start!
        mapboxgl.accessToken = 'pk.eyJ1IjoibmFuY3l3bmciLCJhIjoiY2ptOGRueHF2MTVvdzNwbjM0YXV3eHY5MiJ9.CDTHY7P6jXqx9UQRoXIseA';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [-84.4461, 33.7750],
            zoom: 12
        });
        var points = [];

        // legends
        var legend = ['bank', 'gas station', 'library', 'school', 'park', 'restaurants'];
        var colors = ['#a2719b', '#2dc4b2', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C'];
        var legends = document.getElementById('legends');
        for (i = 0; i < legend.length; i++) {
            var layer = legend[i];
            var color = colors[i];
            var item = document.createElement('div');
            var key = document.createElement('span');
            key.className = 'legend-key';
            key.style.backgroundColor = color;

            var value = document.createElement('span');
            value.innerHTML = layer;
            item.appendChild(key);
            item.appendChild(value);
            legends.appendChild(item);
        }

        map.on('load', function () {       /* 为map添加load事件监听器 */
            map.addSource("route", {       /* addSource()函数添加资源,资源ID是route */
                "type": "geojson",
                lineMetrics: true,
                "data": {                  /* GeoJSON格式数据 */
                    "type": "Feature",
                    "properties": {},
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [-84.395055,33.760312],
                            [-84.395065,33.760812],
                            [-84.399055,33.770312],
                            [-84.480055,33.790312],
                            [-84.535055,33.820312],
                            [-84.655055,33.830312],
                            [-84.751566, 33.843340]
                        ]
                    }
                }
            });
        
            map.addLayer({                 /* 为地图添加layer */
                "id": "route",             /* layer id是route */
                "type": "line",            /* line类型layer*/
                "source": "route",         /* 资源引用的是上面定义的source*/
                "layout": {
                    "line-join": "round",  /* 线条相交的形状 */
                    "line-cap": "round"    /* 线条末端形状 */
                },
                "paint": {
                    "line-color": "#888",  /* 线条颜色 */
                    "line-width": 8,       /* 线条宽度 */
                    'line-gradient': [
                        'interpolate',
                        ['linear'],
                        ['line-progress'],
                        0, "blue",
                        0.1, "royalblue",
                        0.3, "cyan",
                        0.5, "lime",
                        0.7, "yellow",
                        1, "red"
                        ]
                }
            });
        });


        // data: 'https://xxx' link to database server with project data'
        map.on('load', function () {
            map.addLayer({
                id: 'assets',
                type: 'circle',
                source: {
                    type: 'geojson',
                    data: userdata,
                },
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['number', ['get', 'Number']],
                        0, 4,
                        5, 24
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['number', ['get', 'Number']],
                        0, '#a2719b',
                        1, '#2dc4b2',
                        2, '#FEB24C',
                        3, '#FD8D3C',
                        4, '#FC4E2A',
                        5, '#E31A1C'
                    ],
                    'circle-opacity': 0.8
                }
            });
        });

        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'assets', function () {
            map.getCanvas().style.cursor = 'pointer';
        });
        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'assets', function () {
            map.getCanvas().style.cursor = '';
        });

        // manages what type of click it is
        var onDot = false;
        // popup on dots
        map.on('click', 'assets', function (e) {
            onDot = true;
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;
            
            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            
            new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
        });
        // get coordinate
        map.on('click', function (e, points) {
            if (!onDot) {
                document.getElementById('info').innerHTML =
                // e.point is the x, y coordinates of the mousemove event relative
                // to the top-left corner of the map
                // JSON.stringify(e.point) + '<br />' +
                // e.lngLat is the longitude, latitude geographical position of the event
                JSON.stringify(e.lngLat.wrap());
                var curClick = {
                    "type": "Feature",
                    "properties": {
                        "Year": 0,
                        "Name": "Click",
                        "Type": "click",
                        "Number": 1,
                        "description": "just selected point"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [e.lngLat.lng, e.lngLat.lat]
                    }
                }
                includeClick = {
                    "type": "FeatureCollection",
                    "features": userdata['features'].concat([curClick])
                }
                console.log(includeClick)
                map.getSource("assets").setData(includeClick);
                var point = [e.lngLat.lng, e.lngLat.lat];
                Arraypush(point);
            } else {
                onDot = false;
            }
        });
        // slidebar
        document.getElementById('slider').addEventListener('input', function (e) {
            var year = parseInt(e.target.value);
            map.setFilter('assets', ['<=', ['number', ['get', 'Year']], year]);
            document.getElementById('yr').textContent = year;
        });
        function Arraypush(point) {
            points.push(point);
            console.log(points);
        }

    </script>
</body>
</html>