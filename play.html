<html>
<head>
    <meta charset=utf-8 />
    <title>Grove Park Asset Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
    <link rel='stylesheet' type='text/css' href='styles.css'>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>

    <style type="text/css">

        body {
            margin: 0;
        }

        #demo-container {
            text-align: center;
            margin: 40px auto;
        }

        #file-input-label {
            width: 200px;
            cursor: pointer;
            background-color: #336699;
            color: white;
            padding: 10px;
            display: block;
            margin: 0 auto;
        }

        #file-input {
            display: none;
        }

        #file-progress-container {
            display: none;
            margin: 15px 0 0 0;
        }

        #contents {
            margin: 15px 0 0 0;
            display: none;
            text-align: left;
            background-color: rgba(0,0,0,0.1);
            padding: 10px;
            font-size: 13px;
            max-height: 300px;
            overflow: auto;
        }

    </style>

</head>

<body>

    <div id='map'></div>
    <div id='console'>
        <h1>Grove Park Area Recent Development Projects</h1>
        <p>Data:
            <a href='https://groveparkfoundation.org'>Community Development Project Data</a> Last Updated Jan 2019</p>
        <h2>Type of Assets</h2>
        <div id='legends'></div>
        <div class='session' id='sliderbar'>
            <h2>Year:
                <label id='active-hour'>2015-2025</label>
            </h2>
            <input id='slider' class='row' type='range' min='2015' max='2025' step='1' value='2019' />
            <label id='yr'></label>
        </div>
        <div id="demo-container">
            <label for="file-input" id="file-input-label">Upload CSV File</label>
            <input type="file" id="file-input" accept="text/csv" />
            <div id="file-progress-container"><span id="file-progress-percent"></span>% read</div>
            <div id="contents"></div>
        </div>
    </div>

    <script type="text/javascript">
        document.querySelector("#file-input").addEventListener('change', function() {
            // files that user has chosen
            var all_files = this.files;
            if(all_files.length == 0) {
                alert('Error : No file selected');
                return;
            }

            // first file selected by user
            var file = all_files[0];

            // files types allowed
            var allowed_types = [ 'text/csv' ];
            if(allowed_types.indexOf(file.type) == -1) {
                alert('Error : Incorrect file type');
                return;
            }

            // Max 2 MB allowed
            var max_size_allowed = 2*1024*1024
            if(file.size > max_size_allowed) {
                alert('Error : Exceeded size 2MB');
                return;
            }

            // file validation is successfull
            // we will now read the file

            var reader = new FileReader();

            // rough algorithm to get CSV data from text
            reader.addEventListener('load', function(e) {
                // contents as text
                var text = e.target.result;

                // will hold CSV data
                var data = [];

                // split by line breaks
                var rows = text.split("\r");

                for(var i=0; i<rows.length; i++) {
                    // split each row by comma
                    var row_columns = rows[i].split(",");

                    data.push(row_columns);
                }

                // CSV data
                console.log(data);
            });

            // file reading failed
            reader.addEventListener('error', function() {
                alert('Error : Failed to read file');
            });

            // read as text file
            reader.readAsText(file);
        });

        // var userdata = {
        //     "type": "FeatureCollection",
        //     "features": []
        // }

        // for (var i=1; i < data.length; i++) {
        //     console.log("here");
        //     var item = {};
        //     item["type"] = "Feature";
        //     var propVal = {};
        //     propVal["Year"] = data[i][0];
        //     propVal["Name"] = data[i][1];
        //     propVal["Type"] = data[i][2];
        //     propVal["Number"] = data[i][3];
        //     item["properties"] = propVal;
        //     var geoVal = {};
        //     geoVal["type"] = "Point";
        //     geoVal["coordinates"] = [data[i][5], data[i][6]];
        //     userdata["features"].push(item);
        // }


        var mydata = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "properties": {
                    "Year": 2020,
                    "Name": "Elementary School",
                    "Type": "school",
                    "Number": 1,
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [-84.4537, 33.778397]
                }
            }, {
                "type": "Feature",
                "properties": {
                    "Year": 2017,
                    "Name": "County Library",
                    "Type": "library",
                    "Number": 2
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [-84.44721, 33.7745]
                }
            }]
        };

        // place with Mapbox token before start!
        mapboxgl.accessToken = 'pk.eyJ1IjoibmFuY3l3bmciLCJhIjoiY2ptOGRueHF2MTVvdzNwbjM0YXV3eHY5MiJ9.CDTHY7P6jXqx9UQRoXIseA';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [-84.4461, 33.7750],
            zoom: 12
        });

        // legends
        var legend = ['bank', 'gas station', 'library', 'school', 'park', 'restaurants'];
        var colors = ['#a2719b', '#2dc4b2', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C'];
        var legends = document.getElementById('legends');
        for (i = 0; i < legend.length; i++) {
            var layer = legend[i];
            var color = colors[i];
            var item = document.createElement('div');
            var key = document.createElement('span');
            key.className = 'legend-key';
            key.style.backgroundColor = color;

            var value = document.createElement('span');
            value.innerHTML = layer;
            item.appendChild(key);
            item.appendChild(value);
            legends.appendChild(item);
        }

        // data: 'https://xxx' link to database server with project data'
        map.on('load', function () {
            map.addLayer({
                id: 'assets',
                type: 'circle',
                source: {
                    type: 'geojson',
                    data: mydata,
                },
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['number', ['get', 'Number']],
                        0, 4,
                        5, 24
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['number', ['get', 'Number']],
                        0, '#a2719b',
                        1, '#2dc4b2',
                        2, '#FEB24C',
                        3, '#FD8D3C',
                        4, '#FC4E2A',
                        5, '#E31A1C'
                    ],
                    'circle-opacity': 0.8
                }
            });
        });
        // slidebar
        document.getElementById('slider').addEventListener('input', function (e) {
            var year = parseInt(e.target.value);
            map.setFilter('assets', ['<=', ['number', ['get', 'Year']], year]);
            document.getElementById('yr').textContent = year;
        });
    </script>
</body>
</html>